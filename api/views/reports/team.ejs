<!DOCTYPE html>
<html lang="en">
<head>
  <title>Team <%= teamNumber %> - <%= assignmentName %> (progress report)</title>
  <%- include("../partials/bootstraphead"); %>
  <%- include("../partials/reportstyle"); %>
</head>
<body class="bg-light p-2">
  <div class="container-fluid">
    <!-- Header -->
    <div class="row mb-2">
      <div class="col-12">
        <h4 class="mb-0 text-dark fw-bold">Team <%= teamNumber %> - <%= assignmentName %></h4>
        <% if (supervisors.length > 0) { %>
        <small class="text-muted">Supervised by: <%= supervisors.join(", ") %></small>
        <br />
        <% } else { %>
        <small class="text-muted">No team supervisor</small>
        <br />
        <% } %>
        <small class="text-muted">
          Generated on <%= generatedDate %>
          <% if (typeof peerReview !== "undefined") { %>
          for the peer review week beginning <%= peerReview?.periodStart %>

          <% if (typeof peerReview.name !== "undefined") { %>
          (<%= peerReview.name %>)

          <% } %>
          <% } %>
        </small>
      </div>
    </div>

    <!-- Student Detail Accordion -->
    <div class="row my-2">
      <div class="col-12">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-dark text-white p-1">
            <h6 class="mb-0"><i class="bi bi-person-arms-up ms-1 me-2"></i>Team members</h6>
          </div>

          <div class="card-body p-0">
            <div class="accordion accordion-flush" id="studentAccordion">
              <% Object.entries(members).forEach(function([memberId, member]) { %>
                <div class="accordion-item">
                  <div class="accordion-header" id="heading<%= memberId %>">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse<%= memberId %>">
                      <div>
                        <span class="fw-medium"><%= member.displayName %></span>
                        <small class="text-muted ms-3"><%= member.email %></small>
                      </div>
                    </button>
                  </div>

                  <div id="collapse<%= memberId %>" class="accordion-collapse collapse print-show" data-bs-parent="#studentAccordion">
                    <div class="accordion-body px-3 py-1">
                      <div class="row d-flex gx-3 gy-2 mb-3">
                        <!-- Meeting Summary -->
                        <%
                          const attendanceRate = member?.attendance?.rate ?? 0;
                          let attendanceBarColour = "";
                          if (attendanceRate <= 50) {
                            attendanceBarColour = "progress-red";
                          } else if (attendanceRate <= 80) {
                            attendanceBarColour = "progress-yellow";
                          } else {
                            attendanceBarColour = "progress-green";
                          }

                          const minutesRecorded = member?.minutesRecorded ?? 0;

                          const actionRate = member?.meetingActions?.rate ?? 0;
                          const actionsCount = member?.meetingActions?.total ?? 0; 
                          let actionBarColour = "";
                          if (actionRate <= 40) {
                            actionBarColour = "progress-red";
                          } else if (actionRate <= 70) {
                            actionBarColour = "progress-yellow";
                          } else {
                            actionBarColour = "progress-green";
                          }
                        %>
                        <div class="col-12 col-sm-6 col-xl-3 d-flex">
                          <div class="metric-card flex-fill">
                            <div class="section-title">Meetings</div>
                            
                            <% if (meetings.count > 0) { %>
                            <div class="metric-row">
                              <div class="d-flex justify-content-between align-items-center">
                                <span class="small text-muted">Attendance</span>
                                <span class="small fw-medium"><%= attendanceRate %>%</span>
                              </div>
                              <div class="progress compact-progress">
                                <div class="progress-bar <%= attendanceBarColour %>" style="width: <%= attendanceRate %>%"></div>
                              </div>
                            </div>

                            <div class="metric-row">
                              <div class="d-flex justify-content-between align-items-center">
                                <span class="small text-muted">Actions completed</span>
                                <span class="small fw-medium"><%= member?.meetingActions?.complete ?? 0 %>/<%= member?.meetingActions?.total ?? 0%></span>
                              </div>
                              <div class="progress compact-progress">
                                <div class="progress-bar <%= actionBarColour %>" style="width: <%= actionRate %>%"></div>
                              </div>
                            </div>

                            <div class="metric-row">
                              <div class="d-flex justify-content-between align-items-center">
                                <span class="small text-muted">Minutes recorded</span>
                                <span class="small fw-medium"><%= minutesRecorded %> meeting<% if (minutesRecorded !== 1) { %>s<% } %></span>
                              </div>
                            </div>
                            
                            <% } else { %>
                            <div class="text-danger small mb-2"><i class="bi bi-exclamation-triangle"></i> No meetings recorded during this period.</div>
                            <% } %>
                          </div>
                        </div>

                        <!-- Skills Summary -->
                        <div class="col-12 col-sm-6 col-xl-3 d-flex">
                          <div class="metric-card flex-fill">
                            <div class="section-title">Peer-rated skills</div>

                            <% if (peerReviewCount === 0) { %>

                            <div class="text-muted small mb-2"><i class="bi bi-dash-circle"></i> No peer reviews configured for this period.</div>

                            <% } else if (typeof member?.skillRatings == "undefined") { %>

                            <div class="text-muted small mb-2"><i class="bi bi-exclamation-triangle"></i> Nobody completed a peer review for <%= member.displayName %>.</div>

                            <% } else if (Object.keys(member?.skillRatings).length > 0) {

                              Object.entries(member?.skillRatings ?? {}).forEach(([skill, value]) => {
                              const rating = parseFloat(value);
                              const skillWidth = ((rating - 0.75) / 4.25) * 100;
                              let skillBarColour = "";

                              if (rating <= 2) {
                                skillBarColour = "progress-red";
                              } else if (rating <= 3.5) {
                                skillBarColour = "progress-yellow";
                              } else {
                                skillBarColour = "progress-green";
                              }
                            %>
                            <div class="metric-row">
                              <div class="d-flex justify-content-between align-items-center">
                                <span class="small text-muted"><%= skill %></span>
                                <span class="small fw-medium"><%= rating %> <i class="bi bi-star-fill small text-dark"></i></span>
                              </div>
                              <div class="progress compact-progress">
                                <div class="progress-bar <%= skillBarColour %>" style="width: <%= skillWidth %>%"></div>
                              </div>
                            </div>
                            <% });
                            } else { %>
                            <div class="text-muted small mb-2"><i class="bi bi-exclamation-triangle"></i> Nobody completed a peer review for <%= member.displayName %>.</div>
                            <% } %>
                          </div>
                        </div>

                        <!-- Engagement Summary -->
                        <div class="col-12 col-sm-6 col-xl-3 d-flex">
                          <div class="metric-card flex-fill">
                            <div class="section-title">Check-in Engagement</div>
                            <%
                              const checkinsCompleted = member?.checkinsSubmitted ?? 0;
                              const checkinsTotal = peerReviewCount ?? 0;
                              const checkinRate = Math.round(checkinsCompleted / checkinsTotal * 100) ?? 0;
                              let checkinBarColour = "";
                              if (checkinRate <= 50) {
                                checkinBarColour = "progress-red";
                              } else if (checkinRate <= 90) {
                                checkinBarColour = "progress-yellow";
                              } else {
                                checkinBarColour = "progress-green";
                              }
                              
                              const avgLength = member?.commentLength;
                              const lengthPercent = avgLength ? Math.min(avgLength / 175 * 100, 100) : 0;
                              let lengthBarColour = "";
                              let lengthLabel = "N/A";
                              if (avgLength <= 60) {
                                lengthBarColour = "progress-red";
                                lengthLabel = "Short";
                              } else if (avgLength <= 125) {
                                lengthBarColour = "progress-yellow";
                                lengthLabel = "Average";
                              } else if (avgLength > 125) {
                                lengthBarColour = "progress-green";
                                lengthLabel = "Detailed";
                              }

                            %>

                            <% if (peerReviewCount > 0) { %>
                            <div class="metric-row">
                              <div class="d-flex justify-content-between align-items-center">
                                <span class="small text-muted">Check-ins completed</span>
                                <span class="small fw-medium"><%= checkinsCompleted %>/<%= checkinsTotal %></span>
                              </div>
                              <div class="progress compact-progress">
                                <div class="progress-bar <%= checkinBarColour %>" style="width: <%= checkinRate %>%"></div>
                              </div>
                            </div>

                            <div class="metric-row">
                              <div class="d-flex justify-content-between align-items-center">
                                <span class="small text-muted">Review comment length</span>
                                <span class="small fw-medium"><%= lengthLabel %></span>
                              </div>
                              <div class="progress compact-progress">
                                <div class="progress-bar <%= lengthBarColour %>" style="width: <%= lengthPercent %>%"></div>
                              </div>
                            </div>

                            <% } else { %>
                              <div class="text-muted small mb-2"><i class="bi bi-dash-circle"></i> No check-ins configured for this period.</div>
                            <% } %>
                          </div>
                        </div>

                        <!-- Workload balance summary -->
                        <div class="col-12 col-sm-6 col-xl-3 d-flex">
                          <div class="metric-card flex-fill">
                            <div class="section-title">Workload balance</div>
                            <% 
                              const effortScoreToLabel = (score) => {
                                if (score <= checkinThresholds.low) return "low";
                                if (score >= checkinThresholds.high) return "high";
                                return "average";
                              };

                              // Widths: -50% for full negative, +50% for full postive
                              const selfScore = member?.checkinScoreSelf;
                              let selfScoreWidthL = 0;
                              let selfScoreWidthR = 0;
                              let selfScoreString;
                              if (typeof selfScore != "undefined") {
                                selfScoreWidthL = Math.min(50, Math.max(0, selfScore / checkinThresholds.min * 50));
                                selfScoreWidthR = Math.min(50, Math.max(0, selfScore / checkinThresholds.max * 50));
                                selfScoreString = `${selfScore > 0 ? "+"+selfScore : selfScore} (${effortScoreToLabel(selfScore)})`;
                              } else {
                                selfScoreString = "None submitted";
                              }

                              const peerScore = member?.checkinScorePeers;
                              let peerScoreWidthL = 0;
                              let peerScoreWidthR = 0;
                              let peerScoreString;
                              if (typeof peerScore != "undefined") {
                                peerScoreWidthL = Math.min(50, Math.max(0, peerScore / checkinThresholds.min * 50));
                                peerScoreWidthR = Math.min(50, Math.max(0, peerScore / checkinThresholds.max * 50));
                                peerScoreString = `${peerScore > 0 ? "+"+peerScore : peerScore} (${effortScoreToLabel(peerScore)})`;
                              } else {
                                peerScoreString = "None submitted";
                              }
                            %>
                            <% if (peerReviewCount > 0) { %>
                            <div class="metric-row">
                              <div class="d-flex justify-content-between align-items-center">
                                <span class="small text-muted">Self-perceived effort</span>
                                <span class="small fw-medium"><%= selfScoreString %></span>
                              </div>
                              <div class="progress compact-progress progress-centred">
                                <div class="progress-bar progress-left progress-red" style="width: <%= selfScoreWidthL%>%"></div>
                                <div class="progress-bar progress-right progress-green" style="width: <%= selfScoreWidthR%>%"></div>
                                <div class="progress-bar-middle"></div>
                              </div>
                            </div>

                            <div class="metric-row">
                              <div class="d-flex justify-content-between align-items-center">
                                <span class="small text-muted">Peer-reviewed effort</span>
                                <span class="small fw-medium"><%= peerScoreString %></span>
                              </div>
                              <div class="progress compact-progress progress-centred">
                                <div class="progress-bar progress-left progress-red" style="width: <%= peerScoreWidthL%>%"></div>
                                <div class="progress-bar progress-right progress-green" style="width: <%= peerScoreWidthR%>%"></div>
                                <div class="progress-bar-middle"></div>
                              </div>
                            </div>

                            <% } else { %>
                              <div class="text-muted small mb-2"><i class="bi bi-dash-circle"></i> No check-ins configured for this period.</div>
                            <% } %>
                          </div>
                        </div>
                      </div>

                      <!-- Peer review comments -->
                      <% if (typeof member?.reviewComments !== "undefined") { %>
                      <div class="mt-3">
                        <div class="section-title">Peer review comments</div>
                        <% if ((member?.reviewComments ?? []).length > 0) { %>
                          <% member?.reviewComments.forEach(function(comment, index) { %>
                          <div class="comment-item" data-comment>
                            <div class="small comment-text"><%= comment.comment || "[Comment removed]" %></div>
                            <div class="text-muted small">
                              — <%= comment.by %>
                              <% if (comment.moderated) { %>
                                <span class="text-danger ms-1"><i class="bi bi-exclamation-triangle"></i> Moderated</span>
                              <% } %>
                            </div>
                          </div>
                          <% }); %>
                        <% } else { %>
                          <div class="text-muted small mb-2"><i class="bi bi-exclamation-triangle"></i> Nobody completed a peer review for <%= member.displayName %>.</div>
                        <% } %>
                      </div>
                      <% } %>

                      <!-- Individual observation comments -->
                      <% if (typeof individualObservations !== "undefined") {
                        const studentObservations = (individualObservations ?? []).filter(o => {
                          return (o?.students ?? []).some(s => memberId == s);
                        });
                        if (studentObservations.length > 0) { %>
                        <div class="mt-3">
                          <div class="section-title">Supervisor/staff observations</div>
                          <% studentObservations.forEach(function(observation, index) { %>
                          <div class="comment-item">
                            <div class="small comment-text"><%= observation?.comment %></div>
                            <div class="text-muted small">
                              — <%= observation?.observer?.displayName %>, <%= observation?.createdAt %>
                            </div>
                          </div>
                          <% }); %>
                        </div>
                      <% }} %>
                      
                    </div>
                  </div>
                </div>
              <% }); %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Meetings Overview - Compressed -->
    <div class="row mb-2 new-page-before">
      <div class="col-4">
        <div class="card border-0 shadow-sm">
          <div class="card-body text-center compact-metric">
            <div class="display-5 text-primary fw-bold mb-0"><%= meetings.count %></div>
            <div class="text-muted small">Meetings (within selected period)</div>
          </div>
        </div>
      </div>
      <div class="col-4">
        <div class="card border-0 shadow-sm">
          <div class="card-body text-center compact-metric">
            <div class="display-5 text-primary fw-bold mb-0"><%= meetings.avgDaysBetween ?? "N/A" %></div>
            <div class="text-muted small">Avg. days between meetings</div>
          </div>
        </div>
      </div>
      <div class="col-4">
        <div class="card border-0 shadow-sm">
          <div class="card-body text-center compact-metric">
            <div class="display-5 text-primary fw-bold mb-0"><%= meetings.actionsCount ?? 0 %></div>
            <div class="text-muted small">Actions created</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Whole team observations -->
    <% if (typeof teamObservations !== "undefined" && teamObservations?.length > 0) { %> 
    <div class="row my-2">
      <div class="col-12">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-dark text-white p-1">
            <h6 class="mb-0"><i class="bi bi-eyeglasses ms-1 me-2"></i>Team observations</h6>
          </div>

          <div class="card-body p-2">
            <% teamObservations.forEach(function(observation, index) { %>
            <div class="comment-item">
              <div class="small comment-text"><%= observation?.comment %></div>
              <div class="text-muted small">
                — <%= observation?.observer?.displayName %>, <%= observation?.createdAt %>
              </div>
            </div>
            <% }); %>
          </div>
        </div>
      </div>
    </div>
    <% } %>

  </div>

  <script>
    const sendCommentMessage = ({commentType, commentText, recipientName, reviewerName, moderated=false}) => {
      var message = {
        type: commentType,
        comment: commentText,
        recipient: recipientName,
        reviewerName: reviewerName,
        moderated: moderated,
      };
      window.parent.postMessage(message, "*");
    }

    const commentClickedHandler = (e) => {
      sendCommentMessage({
        commentType: "peerReview",
        commentText: "Hello! This is a peer review comment.",
        recipientName: "Bob Smith",
      });
    };
  </script>
</body>
</html>
