<!DOCTYPE html>
<html lang="en">
<head>
  <title>Team <%= teamNumber %> - <%= assignmentName %> (progress report)</title>
  <%- include('../partials/head'); %>
  <style>
    @media print {
      .container-fluid { max-width: 100% !important; }
      .card { break-inside: avoid; }
      .table { break-inside: avoid; }
      .shadow-sm { box-shadow: none !important; }
      .bg-light { background-color: white !important; }
      body { font-size: 12px !important; }
      .display-5 { font-size: 2rem !important; }
      .btn, .badge { -webkit-print-color-adjust: exact; }
    }

    @media print {
      .collapse.print-show {
        display: block !important;
        height: auto !important;
        visibility: visible !important;
      }

      .accordion-button::after {
        display: none !important;
      }

      .accordion-collapse.print-show {
        display: block !important;
        height: auto !important;
        visibility: visible !important;
      }

      .accordion-button.collapsed {
        background-color: #f8f9fa !important;
      }

      .progress-bar, .progress {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      .progress {
        background-color: #e9ecef !important;
      }
    }
    
    .compact-metric {
      padding: 0.75rem !important;
    }
    
    .compact-table td, .compact-table th {
      padding: 0.25rem 0.5rem !important;
      font-size: 0.875rem;
    }
    
    .team-member-item {
      padding: 0.25rem 0;
      border-bottom: 1px solid #e9ecef;
    }
    
    .team-member-item:last-child {
      border-bottom: none;
    }
    
    .progress-sm {
      height: 16px !important;
      font-size: 0.7rem;
    }
  </style>
</head>
<body class="bg-light p-2">
  <div class="container-fluid">
    <!-- Header -->
    <div class="row mb-2">
      <div class="col-12">
        <h4 class="mb-0 text-dark fw-bold">Team <%= teamNumber %> - <%= assignmentName %></h4>
        <% if (supervisors.length > 0) { %>
        <small class="text-muted">Supervised by: <%= supervisors.join(", ") %></small>
        <br />
        <% } else { %>
        <small class="text-muted">No team supervisor</small>
        <br />
        <% } %>
        <small class="text-muted">Report generated on <%= generatedDate %></small>
      </div>
    </div>

    <!-- Student Detail Accordion -->
    <div class="row my-2">
      <div class="col-12">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-dark text-white py-1">
            <h6 class="mb-0 small"><i class="bi bi-person-badge-fill me-1"></i>Student Profiles</h6>
          </div>

          <div class="card-body p-1">
            <div class="accordion accordion-flush" id="studentAccordion">
              <% teamMembers.forEach(function(member, index) { %>
                <div class="accordion-item">
                  <h2 class="accordion-header" id="heading<%= index %>">
                    <button class="accordion-button collapsed py-1 px-2 small" type="button" data-bs-toggle="collapse" data-bs-target="#collapse<%= index %>" aria-expanded="false" aria-controls="collapse<%= index %>">
                      <%= member.displayName %> <small class="ms-2 text-muted">(<%= member.email %>)</small>
                    </button>
                  </h2>
                  <div id="collapse<%= index %>" class="accordion-collapse collapse print-show" aria-labelledby="heading<%= index %>" data-bs-parent="#studentAccordion">
                    <div class="accordion-body py-1 small">
                      <div class="row gx-3">
                        <!-- Attendance Summary -->
                        <div class="col-md-6 col-12 mb-2">
                          <div class="fw-semibold text-dark mb-1">Meetings to date</div>
                          <div class="progress progress-sm mt-1">
                            <div class="progress-bar 
                              <%= (attendance[member.displayName].rate || 0) >= 80 ? 'bg-success' : 
                                  (attendance[member.displayName].rate || 0) >= 60 ? 'bg-warning' : 'bg-danger' %>"
                                style="width: <%= attendance[member.displayName].rate || 0 %>%;">
                              <%= attendance[member.displayName].rate || 0 %>% attendance
                            </div>
                          </div>
                        </div>

                        <!-- Skills Summary -->
                        <div class="col-md-6 col-12 mb-2">
                          <div class="fw-semibold text-dark mb-1">Skills</div>
                          <% if (member.skills && Object.keys(member.skills).length > 0) { %>
                            <% Object.entries(member.skills).forEach(([skill, value]) => { %>
                              <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted"><%= skill %></span>
                                <div class="progress progress-sm flex-grow-1 ms-2">
                                  <div class="progress-bar bg-info" style="width: <%= value %>%;">
                                    <%= value %>%
                                  </div>
                                </div>
                              </div>
                            <% }) %>
                          <% } else { %>
                            <div class="text-muted">No skill ratings</div>
                          <% } %>
                        </div>
                      </div>

                      <!-- Review -->
                      <div class="mt-2">
                        <div class="fw-semibold text-dark mb-1">Review</div>
                        <div class="text-muted">
                          <%= member.review || "No comments provided." %>
                        </div>
                      </div>
                    </div>

                  </div>
                </div>
              <% }); %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Meetings Overview - Compressed -->
    <div class="row mb-2">
      <div class="col-6">
        <div class="card border-0 shadow-sm">
          <div class="card-body text-center compact-metric">
            <div class="display-5 text-primary fw-bold mb-0"><%= meetings.count %></div>
            <div class="text-muted small">Meetings</div>
          </div>
        </div>
      </div>
      <div class="col-6">
        <div class="card border-0 shadow-sm">
          <div class="card-body text-center compact-metric">
            <div class="display-5 text-info fw-bold mb-0"><%= meetings.avgDaysBetween %></div>
            <div class="text-muted small">Avg Days</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Attendance Table - Compressed -->
    <div class="row">
      <div class="col-12">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-primary text-white py-1">
            <h6 class="mb-0 small"><i class="bi bi-bar-chart-fill me-1"></i>Attendance Overview</h6>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-sm table-hover mb-0 compact-table">
                <thead class="table-light">
                  <tr>
                    <th scope="col" class="fw-semibold">Member</th>
                    <th scope="col" class="text-center">
                      <i class="bi bi-check-circle-fill text-success"></i>
                    </th>
                    <th scope="col" class="text-center">
                      <i class="bi bi-slash-circle-fill text-warning"></i>
                    </th>
                    <th scope="col" class="text-center">
                      <i class="bi bi-x-circle-fill text-danger"></i>
                    </th>
                    <th scope="col" class="text-center">Attendance</th>
                  </tr>
                </thead>
                <tbody>
                  <% Object.keys(attendance).forEach(member => { %>
                  <tr>
                    <td class="fw-semibold"><%= member %></td>
                    <td class="text-center">
                      <span class="badge bg-success rounded-pill px-2 py-1"><%= attendance[member].attended %></span>
                    </td>
                    <td class="text-center">
                      <span class="badge bg-warning rounded-pill px-2 py-1"><%= attendance[member].apologies %></span>
                    </td>
                    <td class="text-center">
                      <span class="badge bg-danger rounded-pill px-2 py-1"><%= attendance[member].absent %></span>
                    </td>
                    <td class="text-center">
                      <div class="progress progress-sm">
                        <div class="progress-bar <%= attendance[member].rate >= 80 ? 'bg-success' : attendance[member].rate >= 60 ? 'bg-warning' : 'bg-danger' %>" 
                             role="progressbar" 
                             style="width: <%= attendance[member].rate %>%;" 
                             aria-valuenow="<%= attendance[member].rate %>" 
                             aria-valuemin="0" aria-valuemax="100">
                          <span class="fw-semibold"><%= attendance[member].rate %>%</span>
                        </div>
                      </div>
                    </td>
                  </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</body>
</html>
