<!DOCTYPE html>
<html lang="en">
<head>
  <title>Team <%= teamNumber %> - <%= assignmentName %> (progress report)</title>
  <%- include('../partials/head'); %>
  <style>
    @media print {
      .container-fluid { max-width: 100% !important; }
      .card { break-inside: avoid; }
      .table { break-inside: avoid; }
      .shadow-sm { box-shadow: none !important; }
      .bg-light { background-color: white !important; }
      .display-5 { font-size: 2rem !important; }
      .btn, .badge { -webkit-print-color-adjust: exact; }

      .collapse.print-show {
        display: block !important;
        height: auto !important;
        visibility: visible !important;
      }

      .accordion-button::after {
        display: none !important;
      }

      .accordion-collapse.print-show {
        display: block !important;
        height: auto !important;
        visibility: visible !important;
      }

      .accordion-button.collapsed {
        background-color: #f8f9fa !important;
      }

      .progress-bar, .progress {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      .progress {
        background-color: #e9ecef !important;
      }

      .new-page-after {
        break-after: page;
        margin-top: 1em;
      }
    }
    
    .compact-metric {
      padding: 0.75rem !important;
    }
    
    .compact-table td, .compact-table th {
      padding: 0.25rem 0.5rem !important;
      font-size: 0.875rem;
    }
    
    .team-member-item {
      padding: 0.25rem 0;
      border-bottom: 1px solid #e9ecef;
    }
    
    .team-member-item:last-child {
      border-bottom: none;
    }
    
    .progress-sm {
      height: 16px !important;
      font-size: 0.7rem;
    }

    .fake-bullet-point::before {
      content: "â€¢ ";
    }

    .review-comment::before {
      content: open-quote;
    }

    .review-comment::after {
      content: close-quote;
    }

    .skill-bar { height: 6px; border-radius: 3px; }
  </style>
</head>
<body class="bg-light p-2">
  <div class="container-fluid">
    <!-- Header -->
    <div class="row mb-2">
      <div class="col-12">
        <h4 class="mb-0 text-dark fw-bold">Team <%= teamNumber %> - <%= assignmentName %></h4>
        <% if (supervisors.length > 0) { %>
        <small class="text-muted">Supervised by: <%= supervisors.join(", ") %></small>
        <br />
        <% } else { %>
        <small class="text-muted">No team supervisor</small>
        <br />
        <% } %>
        <small class="text-muted">
          Generated on <%= generatedDate %>
          <% if (typeof peerReview !== "undefined") { %>
          for the peer review week beginning <%= peerReview?.periodStart %>
          <% } %>
        </small>
      </div>
    </div>

    <!-- Student Detail Accordion -->
    <div class="row my-2">
      <div class="col-12">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-dark text-white p-1">
            <h6 class="mb-0"><i class="bi bi-person-arms-up ms-1 me-2"></i>Team members</h6>
          </div>

          <div class="card-body p-0 pb-1">
            <div class="accordion accordion-flush" id="studentAccordion">
              <% teamMembers.forEach(function(member, index) { %>
                <div class="accordion-item new-page-after student-details-item">
                  <h2 class="accordion-header" id="heading<%= index %>">
                    <button class="accordion-button collapsed py-1 px-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapse<%= index %>" aria-expanded="false" aria-controls="collapse<%= index %>">
                      <div>
                        <span class="text-dark"><%= member.displayName %></span>
                        <small class="text-muted ms-2"><%= member.email %></small>
                      </div>
                    </button>
                  </h2>
                  <div id="collapse<%= index %>" class="accordion-collapse collapse print-show" aria-labelledby="heading<%= index %>" data-bs-parent="#studentAccordion">
                    <div class="accordion-body py-1 px-2">
                      <div class="row gx-3">
                        <!-- Attendance Summary -->
                        <div class="col-sm-6 col-12 mb-2">
                          <div class="fw-semibold text-dark">Meetings to date</div>
                          <%
                            const attendanceRate = attendance[member.displayName]?.rate ?? 0;
                            let attendanceBarColour = "";
                            if (attendanceRate <= 50) {
                              attendanceBarColour = "bg-danger";
                            } else if (attendanceRate <= 80) {
                              attendanceBarColour = "bg-warning";
                            } else {
                              attendanceBarColour = "bg-success";
                            }

                            const minutesRecorded = minuteTakers[member.displayName] ?? 0;

                            const actionRate = actionOwners[member.displayName]?.rate ?? 0;
                            const actionsCount = actionOwners[member.displayName]?.total ?? 0; 
                            let actionBarColour = "";
                            if (actionRate <= 40) {
                              actionBarColour = "bg-danger";
                            } else if (actionRate <= 70) {
                              actionBarColour = "bg-warning";
                            } else {
                              actionBarColour = "bg-success";
                            }
                          %>
                          <div class="mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                              <span class="small text-muted">Meeting attendance</span>
                              <span class="small fw-medium d-flex align-items-center text-muted"><%= attendanceRate %>%</span>
                            </div>
                            <div class="progress skill-bar">
                              <div class="progress-bar bg-primary <%= attendanceBarColour %>" style="width: <%= attendanceRate %>%;"></div>
                            </div>
                          </div>
                          <div class="mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                              <span class="small text-muted">Assigned actions completed</span>
                              <span class="small fw-medium d-flex align-items-center text-muted"><%= actionOwners[member.displayName]?.complete ?? 0 %>/<%= actionOwners[member.displayName]?.total ?? 0%></span>
                            </div>
                            <div class="progress skill-bar">
                              <div class="progress-bar bg-primary <%= actionBarColour %>" style="width: <%= actionRate %>%;"></div>
                            </div>
                          </div>
                          <div class="mb-2 small text-muted">
                            Recorded minutes for <span class="fw-medium"><%= minutesRecorded %></span> meeting<% if (minutesRecorded !== 1) { %>s<% } %>
                          </div>
                        </div>

                        <!-- Skills Summary -->
                        <% if (typeof skillRatings !== "undefined") { %>
                        <div class="col-sm-6 col-12 mb-2">
                          <div class="fw-semibold text-dark">Skills (rated by peers)</div>
                          <% Object.entries(skillRatings[member.displayName] ?? {}).forEach(([skill, value]) => { %>
                            <% 
                              const rating = parseFloat(value);
                              const widthPercentage = ((rating - 0.75) / 4.25) * 100;
                              let barColourClass = "";

                              if (rating <= 2) {
                                barColourClass = "bg-danger";
                              } else if (rating <= 3.5) {
                                barColourClass = "bg-warning";
                              } else {
                                barColourClass = "bg-success";
                              }
                            %>
                            <div class="mb-2">
                              <div class="d-flex justify-content-between align-items-center">
                                <span class="small text-muted"><%= skill %></span>
                                <span class="small fw-medium d-flex align-items-center text-muted"><%= value %> <i class="bi bi-star-fill small ms-1"></i></span>
                              </div>
                              <div class="progress skill-bar">
                                <div class="progress-bar bg-primary <%= barColourClass %>" style="width: <%= widthPercentage %>%;"></div>
                              </div>
                            </div>
                          <% }) %>
                        </div>
                        <% } %>

                        <!-- Engagement Summary -->
                        <div class="col-sm-6 col-12 mb-2">
                          <div class="fw-semibold text-dark">Engagement</div>
                          <%
                            const engagementRate = 85;
                            let engagementBarColour = "";
                            let engagementLabel = "Good";
                            if (engagementRate <= 50) {
                              engagementBarColour = "bg-danger";
                              engagementLabel = "Poor";
                            } else if (engagementRate <= 80) {
                              engagementBarColour = "bg-warning";
                              engagementLabel = "Average";
                            } else {
                              engagementBarColour = "bg-success";
                              engagementLabel = "Great";
                            }

                            const checkinsCompleted = 6;
                            const checkinsTotal = 8;
                            const checkinRate = Math.round(checkinsCompleted / checkinsTotal * 100) ?? 0;
                            let checkinBarColour = "";
                            if (checkinRate <= 50) {
                              checkinBarColour = "bg-danger";
                            } else if (checkinRate <= 90) {
                              checkinBarColour = "bg-warning";
                            } else {
                              checkinBarColour = "bg-success";
                            }
                          %>
                          <div class="mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                              <span class="small text-muted">Log in frequency</span>
                              <span class="small fw-medium d-flex align-items-center text-muted"><%= engagementLabel %></span>
                            </div>
                            <div class="progress skill-bar">
                              <div class="progress-bar bg-primary <%= engagementBarColour %>" style="width: <%= engagementRate %>%;"></div>
                            </div>
                          </div>
                          <div class="mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                              <span class="small text-muted">Check-ins completed</span>
                              <span class="small fw-medium d-flex align-items-center text-muted"><%= checkinsCompleted %>/<%= checkinsTotal %></span>
                            </div>
                            <div class="progress skill-bar">
                              <div class="progress-bar bg-primary <%= checkinBarColour %>" style="width: <%= checkinRate %>%;"></div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Peer review comments -->
                      <% if (typeof reviewComments !== "undefined") { %>
                      <div class="mt-2">
                        <div class="fw-semibold text-dark">Peer review comments</div>
                        <% if ((reviewComments[member.displayName] ?? []).length > 0) { %>
                          <% reviewComments[member.displayName].forEach(function(comment, index) { %>
                          <div class="mb-2 small">
                            <span class="text-dark review-comment"><%= comment.comment || "[Comment removed]" %></span>
                            <span class="text-muted ms-1">- <%= comment.by %></span>
                            <%= comment.originalComment %>
                            <% if (comment.moderated) { %>
                              <span class="text-danger ms-1"><i class="bi bi-exclamation-triangle"></i> Moderated</span>
                            <% } %>
                          </div>
                          <% }); %>
                        <% } else { %>
                          <div class="text-muted small">Nobody completed a peer review for <%= member.displayName %>.</div>
                        <% } %>
                        </div>
                      </div>
                      <% } %>

                  </div>
                </div>
              <% }); %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Meetings Overview - Compressed -->
    <div class="row mb-2">
      <div class="col-6">
        <div class="card border-0 shadow-sm">
          <div class="card-body text-center compact-metric">
            <div class="display-5 text-primary fw-bold mb-0"><%= meetings.count %></div>
            <div class="text-muted small">Meetings</div>
          </div>
        </div>
      </div>
      <div class="col-6">
        <div class="card border-0 shadow-sm">
          <div class="card-body text-center compact-metric">
            <div class="display-5 text-info fw-bold mb-0"><%= meetings.avgDaysBetween %></div>
            <div class="text-muted small">Avg Days</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Attendance Table - Compressed -->
    <div class="row">
      <div class="col-12">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-primary text-white py-1">
            <h6 class="mb-0 small"><i class="bi bi-bar-chart-fill me-1"></i>Attendance Overview</h6>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-sm table-hover mb-0 compact-table">
                <thead class="table-light">
                  <tr>
                    <th scope="col" class="fw-semibold">Member</th>
                    <th scope="col" class="text-center">
                      <i class="bi bi-check-circle-fill text-success"></i>
                    </th>
                    <th scope="col" class="text-center">
                      <i class="bi bi-slash-circle-fill text-warning"></i>
                    </th>
                    <th scope="col" class="text-center">
                      <i class="bi bi-x-circle-fill text-danger"></i>
                    </th>
                    <th scope="col" class="text-center">Attendance</th>
                  </tr>
                </thead>
                <tbody>
                  <% Object.keys(attendance).forEach(member => { %>
                  <tr>
                    <td class="fw-semibold"><%= member %></td>
                    <td class="text-center">
                      <span class="badge bg-success rounded-pill px-2 py-1"><%= attendance[member].attended %></span>
                    </td>
                    <td class="text-center">
                      <span class="badge bg-warning rounded-pill px-2 py-1"><%= attendance[member].apologies %></span>
                    </td>
                    <td class="text-center">
                      <span class="badge bg-danger rounded-pill px-2 py-1"><%= attendance[member].absent %></span>
                    </td>
                    <td class="text-center">
                      <div class="progress progress-sm">
                        <div class="progress-bar <%= attendance[member].rate >= 80 ? 'bg-success' : attendance[member].rate >= 60 ? 'bg-warning' : 'bg-danger' %>" 
                             role="progressbar" 
                             style="width: <%= attendance[member].rate %>%;" 
                             aria-valuenow="<%= attendance[member].rate %>" 
                             aria-valuemin="0" aria-valuemax="100">
                          <span class="fw-semibold"><%= attendance[member].rate %>%</span>
                        </div>
                      </div>
                    </td>
                  </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</body>
</html>
