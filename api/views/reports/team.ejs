<!DOCTYPE html>
<html lang="en">
<head>
  <title>Team <%= teamNumber %> - <%= assignmentName %> (progress report)</title>
  <%- include("../partials/bootstraphead"); %>
  <%- include("../partials/reportstyle"); %>
</head>
<body class="bg-light p-2">
  <div class="container-fluid">
    <!-- Header -->
    <div class="row mb-2">
      <div class="col-12">
        <h4 class="mb-0 text-dark fw-bold">Team <%= teamNumber %> - <%= assignmentName %></h4>
        <% if (supervisors.length > 0) { %>
        <small class="text-muted">Supervised by: <%= supervisors.join(", ") %></small>
        <br />
        <% } else { %>
        <small class="text-muted">No team supervisor</small>
        <br />
        <% } %>
        <small class="text-muted">
          Generated on <%= generatedDate %>
          <% if (typeof peerReview !== "undefined") { %>
          for the peer review week beginning <%= peerReview?.periodStart %>
          <% } %>
        </small>
      </div>
    </div>

    <!-- Student Detail Accordion -->
    <div class="row my-2">
      <div class="col-12">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-dark text-white p-1">
            <h6 class="mb-0"><i class="bi bi-person-arms-up ms-1 me-2"></i>Team members</h6>
          </div>

          <div class="card-body p-0">
            <div class="accordion accordion-flush" id="studentAccordion">
              <% teamMembers.forEach(function(member, index) { %>
                <div class="accordion-item">
                  <div class="accordion-header" id="heading<%= index %>">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse<%= index %>">
                      <div>
                        <span class="fw-medium"><%= member.displayName %></span>
                        <small class="text-muted ms-3"><%= member.email %></small>
                      </div>
                    </button>
                  </div>

                  <div id="collapse<%= index %>" class="accordion-collapse collapse print-show" data-bs-parent="#studentAccordion">
                    <div class="accordion-body px-3 py-1">
                      <div class="row d-flex gx-3 gy-2">
                        <!-- Attendance Summary -->
                        <%
                          const attendanceRate = attendance[member.displayName]?.rate ?? 0;
                          let attendanceBarColour = "";
                          if (attendanceRate <= 50) {
                            attendanceBarColour = "progress-red";
                          } else if (attendanceRate <= 80) {
                            attendanceBarColour = "progress-yellow";
                          } else {
                            attendanceBarColour = "progress-green";
                          }

                          const minutesRecorded = minuteTakers[member.displayName] ?? 0;

                          const actionRate = actionOwners[member.displayName]?.rate ?? 0;
                          const actionsCount = actionOwners[member.displayName]?.total ?? 0; 
                          let actionBarColour = "";
                          if (actionRate <= 40) {
                            actionBarColour = "progress-red";
                          } else if (actionRate <= 70) {
                            actionBarColour = "progress-yellow";
                          } else {
                            actionBarColour = "progress-green";
                          }
                        %>
                        <div class="col-12 col-sm-6 col-xl-3 d-flex">
                          <div class="metric-card flex-fill">
                            <div class="section-title">Meetings</div>
                            
                            <div class="metric-row">
                              <div class="d-flex justify-content-between align-items-center">
                                <span class="small text-muted">Attendance</span>
                                <span class="small fw-medium"><%= attendanceRate %>%</span>
                              </div>
                              <div class="progress compact-progress">
                                <div class="progress-bar <%= attendanceBarColour %>" style="width: <%= attendanceRate %>%"></div>
                              </div>
                            </div>

                            <div class="metric-row">
                              <div class="d-flex justify-content-between align-items-center">
                                <span class="small text-muted">Actions completed</span>
                                <span class="small fw-medium"><%= actionOwners[member.displayName]?.complete ?? 0 %>/<%= actionOwners[member.displayName]?.total ?? 0%></span>
                              </div>
                              <div class="progress compact-progress">
                                <div class="progress-bar <%= actionBarColour %>" style="width: <%= actionRate %>%"></div>
                              </div>
                            </div>

                            <div class="metric-row">
                              <div class="d-flex justify-content-between align-items-center">
                                <span class="small text-muted">Minutes recorded</span>
                                <span class="small fw-medium"><%= minutesRecorded %> meeting<% if (minutesRecorded !== 1) { %>s<% } %></span>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Skills Summary -->
                        <% if (typeof skillRatings !== "undefined") { %>
                        <div class="col-12 col-sm-6 col-xl-3 d-flex">
                          <div class="metric-card flex-fill">
                            <div class="section-title">Skills (rated by peers)</div>

                            <% Object.entries(skillRatings[member.displayName] ?? {}).forEach(([skill, value]) => { %>
                            <% 
                              const rating = parseFloat(value);
                              const skillWidth = ((rating - 0.75) / 4.25) * 100;
                              let skillBarColour = "";

                              if (rating <= 2) {
                                skillBarColour = "progress-red";
                              } else if (rating <= 3.5) {
                                skillBarColour = "progress-yellow";
                              } else {
                                skillBarColour = "progress-green";
                              }
                            %>
                            <div class="metric-row">
                              <div class="d-flex justify-content-between align-items-center">
                                <span class="small text-muted"><%= skill %></span>
                                <span class="small fw-medium"><%= rating %> <i class="bi bi-star-fill small text-dark"></i></span>
                              </div>
                              <div class="progress compact-progress">
                                <div class="progress-bar <%= skillBarColour %>" style="width: <%= skillWidth %>%"></div>
                              </div>
                            </div>
                            <% }); %>
                          </div>
                        </div>
                        <% } %>

                        <!-- Engagement Summary -->
                        <div class="col-12 col-sm-6 col-xl-3 d-flex">
                          <div class="metric-card flex-fill">
                            <div class="section-title">Engagement</div>
                            <% 
                              const engagementRate = 85;
                              let engagementBarColour = "";
                              let engagementLabel = "Good";
                              if (engagementRate <= 50) {
                                engagementBarColour = "progress-red";
                                engagementLabel = "Poor";
                              } else if (engagementRate <= 80) {
                                engagementBarColour = "progress-yellow";
                                engagementLabel = "Average";
                              } else {
                                engagementBarColour = "progress-green";
                                engagementLabel = "Great";
                              }

                              const checkinsCompleted = checkinsSubmitted[member.displayName] ?? 0;
                              const checkinsTotal = peerReviewCount ?? 0;
                              const checkinRate = Math.round(checkinsCompleted / checkinsTotal * 100) ?? 0;
                              let checkinBarColour = "";
                              if (checkinRate <= 50) {
                                checkinBarColour = "progress-red";
                              } else if (checkinRate <= 90) {
                                checkinBarColour = "progress-yellow";
                              } else {
                                checkinBarColour = "progress-green";
                              }
                            %>

                            <div class="metric-row">
                              <div class="d-flex justify-content-between align-items-center">
                                <span class="small text-muted">Login frequency</span>
                                <span class="small fw-medium"><%= engagementLabel %></span>
                              </div>
                              <div class="progress compact-progress">
                                <div class="progress-bar <%= engagementBarColour %>" style="width: <%= engagementRate %>%"></div>
                              </div>
                            </div>

                            <div class="metric-row">
                              <div class="d-flex justify-content-between align-items-center">
                                <span class="small text-muted">Check-ins completed</span>
                                <span class="small fw-medium"><%= checkinsCompleted %>/<%= checkinsTotal %></span>
                              </div>
                              <div class="progress compact-progress">
                                <div class="progress-bar <%= checkinBarColour %>" style="width: <%= checkinRate %>%"></div>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Workload balance summary -->
                        <div class="col-12 col-sm-6 col-xl-3 d-flex">
                          <div class="metric-card flex-fill">
                            <div class="section-title">Workload balance</div>
                            <% 
                              const effortScoreToLabel = (score) => {
                                if (score <= checkinThresholds.low) return "low";
                                if (score >= checkinThresholds.high) return "high";
                                return "average";
                              };

                              // Widths: -50% for full negative, +50% for full postive
                              const netScore = netScores[member.displayName] ?? 0;
                              const netScoreWidthL = Math.min(50, Math.max(0, netScore / checkinThresholds.min * 50));
                              const netScoreWidthR = Math.min(50, Math.max(0, netScore / checkinThresholds.max * 50));
                              const netScoreString = netScore > 0 ? "+"+netScore : netScore;
                              
                              const selfScore = selfNetScores[member.displayName] ?? 0;
                              const selfScoreWidthL = Math.min(50, Math.max(0, selfScore / checkinThresholds.min * 50));
                              const selfScoreWidthR = Math.min(50, Math.max(0, selfScore / checkinThresholds.max * 50));
                              const selfScoreString = selfScore > 0 ? "+"+selfScore : selfScore;
                            %>
                            <div class="metric-row">
                              <div class="d-flex justify-content-between align-items-center">
                                <span class="small text-muted">Self-perceived effort</span>
                                <span class="small fw-medium"><%= selfScoreString %> (<%= effortScoreToLabel(selfScore) %>)</span>
                              </div>
                              <div class="progress compact-progress progress-centred">
                                <div class="progress-bar progress-left progress-red" style="width: <%= selfScoreWidthL%>%"></div>
                                <div class="progress-bar progress-right progress-green" style="width: <%= selfScoreWidthR%>%"></div>
                                <div class="progress-bar-middle"></div>
                              </div>
                            </div>

                            <div class="metric-row">
                              <div class="d-flex justify-content-between align-items-center">
                                <span class="small text-muted">Peer-reviewed effort</span>
                                <span class="small fw-medium"><%= netScoreString %> (<%= effortScoreToLabel(netScore) %>)</span>
                              </div>
                              <div class="progress compact-progress progress-centred">
                                <div class="progress-bar progress-left progress-red" style="width: <%= netScoreWidthL%>%"></div>
                                <div class="progress-bar progress-right progress-green" style="width: <%= netScoreWidthR%>%"></div>
                                <div class="progress-bar-middle"></div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Peer review comments -->
                      <% if (typeof reviewComments !== "undefined") { %>
                      <div class="mt-3">
                        <div class="section-title">Peer review comments</div>
                        <% if ((reviewComments[member.displayName] ?? []).length > 0) { %>
                          <% reviewComments[member.displayName].forEach(function(comment, index) { %>
                          <div class="comment-item">
                            <div class="small comment-text"><%= comment.comment || "[Comment removed]" %></div>
                            <div class="text-muted small">
                              â€” <%= comment.by %>
                              <% if (comment.moderated) { %>
                                <span class="text-danger ms-1"><i class="bi bi-exclamation-triangle"></i> Moderated</span>
                              <% } %>
                            </div>
                          </div>
                          <% }); %>
                        <% } else { %>
                          <div class="text-muted small mb-2">Nobody completed a peer review for <%= member.displayName %>.</div>
                        <% } %>
                        </div>
                      </div>
                      <% } %>

                  </div>
                </div>
              <% }); %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Meetings Overview - Compressed -->
    <div class="row mb-2">
      <div class="col-6">
        <div class="card border-0 shadow-sm">
          <div class="card-body text-center compact-metric">
            <div class="display-5 text-primary fw-bold mb-0"><%= meetings.count %></div>
            <div class="text-muted small">Meetings</div>
          </div>
        </div>
      </div>
      <div class="col-6">
        <div class="card border-0 shadow-sm">
          <div class="card-body text-center compact-metric">
            <div class="display-5 text-info fw-bold mb-0"><%= meetings.avgDaysBetween %></div>
            <div class="text-muted small">Avg Days</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Attendance Table - Compressed -->
    <div class="row">
      <div class="col-12">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-primary text-white py-1">
            <h6 class="mb-0 small"><i class="bi bi-bar-chart-fill me-1"></i>Attendance Overview</h6>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-sm table-hover mb-0 compact-table">
                <thead class="table-light">
                  <tr>
                    <th scope="col" class="fw-semibold">Member</th>
                    <th scope="col" class="text-center">
                      <i class="bi bi-check-circle-fill text-success"></i>
                    </th>
                    <th scope="col" class="text-center">
                      <i class="bi bi-slash-circle-fill text-warning"></i>
                    </th>
                    <th scope="col" class="text-center">
                      <i class="bi bi-x-circle-fill text-danger"></i>
                    </th>
                    <th scope="col" class="text-center">Attendance</th>
                  </tr>
                </thead>
                <tbody>
                  <% Object.keys(attendance).forEach(member => { %>
                  <tr>
                    <td class="fw-semibold"><%= member %></td>
                    <td class="text-center">
                      <span class="badge bg-success rounded-pill px-2 py-1"><%= attendance[member].attended %></span>
                    </td>
                    <td class="text-center">
                      <span class="badge bg-warning rounded-pill px-2 py-1"><%= attendance[member].apologies %></span>
                    </td>
                    <td class="text-center">
                      <span class="badge bg-danger rounded-pill px-2 py-1"><%= attendance[member].absent %></span>
                    </td>
                    <td class="text-center">
                      <div class="progress progress-sm">
                        <div class="progress-bar <%= attendance[member].rate >= 80 ? 'bg-success' : attendance[member].rate >= 60 ? 'bg-warning' : 'bg-danger' %>" 
                             role="progressbar" 
                             style="width: <%= attendance[member].rate %>%;" 
                             aria-valuenow="<%= attendance[member].rate %>" 
                             aria-valuemin="0" aria-valuemax="100">
                          <span class="fw-semibold"><%= attendance[member].rate %>%</span>
                        </div>
                      </div>
                    </td>
                  </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</body>
</html>
